# AGENTS.md — MoveCatcher2.mq4「ロット計算」を“単数列分解管理モンテカルロ法”へ置換するための実装指示（Codex用）

## ゴール

* `MoveCatcher2.mq4` の**ロット計算**を、ユーザー提供の**単数列分解管理モンテカルロ法**（以下 DMCMM）ロジックに**完全準拠**させる。
* DMCMM は**各トレードの勝敗判定**（WIN/LOSE）を必要とするため、**勝敗判定の実装**と**状態の永続化**も含めて実装する。
* 既存のエントリー/イグジット・シグナルや発注フローは極力変更せず、**ロット決定のみ**を DMCMM に差し替える（必要箇所にフックを追加）。

---

## 参照仕様（必読）

* Canonical spec: 「単数列分解管理モンテカルロ法.txt」
  初期化・勝敗処理・平均化・0生成・最終ベット計算・連勝倍率の仕様を**厳密順守**すること。
  初期状態（初期数列・ストック・連勝数・ベット計算の出発点）は L1–L10, L14–L21 に記載。&#x20;
  WIN 処理の**連勝数加算条件**（{0,1}パターン勝利時のみ）と WIN 時の数列処理は L42–L61 付近を参照。&#x20;
  LOSE 処理（連勝ストック獲得条件・数列拡張・平均化）は L12–L25, L29–L43 付近を参照。&#x20;
  LOSE 後の**ストック消費**と**0生成（再配布）**は L27–L37（続き含む）を参照。**合計は「先頭0化“後”＋再配布値を足してから」平均/余り計算**である点が重要。&#x20;
  最終ベット額（=（左+右）×基本ベット額×連勝倍率）と**連勝倍率マップ**（≤2→×1、3→×2、4→×3、≥5→×5）は L14–L37 を参照。

---

## スコープと非スコープ

* スコープ

  * ロット決定エンジンを DMCMM に置換
  * 勝敗判定（1トレード単位）
  * DMCMM の状態（初期数列・ストック・連勝数）の永続化
  * 既存発注前のロット決定フック、約定クローズ時の結果反映フックの追加
* 非スコープ

  * シグナル生成や発注条件ロジックの変更
  * 既存の SL/TP・グリッド・ヘッジ等の戦略本体のアルゴリズム変更
  * コード例の提示（この文書では禁止）

---

## 用語とデータ定義（実装が参照すべき名義）

* **初期数列**：整数配列。初期値は {0,1}。
* **ストック**：非負整数。初期 0。
* **連勝数**：非負整数。初期 0。
* **基本ベット額（= BaseLot）**：MoveCatcher2 側のベースロットに相当。仕様ではユーザー入力だが、EA の入力パラメータとみなす。
* **ベット値**：左端値＋右端値。ベット額の係数となる。
* **連勝倍率**：連勝数に応じて {0..2:×1, 3:×2, 4:×3, ≥5:×5} を適用。

---

## DMCMM ロット決定の全体像（手続き設計）

1. **初期化**

   * シンボル×マジック単位の DMCMM 状態をロード。未存在なら初期化：初期数列={0,1}、ストック=0、連勝数=0。
   * BaseLot は EA 入力パラメータ（例：`DMCMM_BaseLot`）を使用。

2. **発注直前（新規建て時）**

   * 現在の初期数列から**ベット値=左端＋右端**を取得し、**ロット=ベット値×BaseLot×連勝倍率**を算出。&#x20;
   * ベット値が 0 の場合は**ロット0**となる。ロット0は発注不可のため、シグナル層は**この建玉をスキップ**すること（次の勝敗処理で系列が更新されロットが復帰する）。

3. **クローズ検出（勝敗判定）**

   * マジック＆シンボルで絞り込んだ**新規にクローズされた注文**を検出（MQL4 では毎ティックで履歴を差分走査）。
   * **WIN 条件**：`OrderProfit + OrderSwap + OrderCommission >= WinEpsMoney`（推奨既定 0.0）。
   * **LOSE 条件**：上記未満。
   * 部分決済は**各決済イベントを独立判定**として逐次 DMCMM に反映。
   * バスケット運用をしていても、本仕様では**各トレード単体**で判定・反映する（ユーザー要望：「各トレードの勝敗を判定」）。

4. **勝敗反映（DMCMM 更新）**

   * **WIN** のとき：

     * 連勝数の加算は\*\*「数列が {0,1} で勝利した場合のみ」\*\*行う（= 連勝数+=1）。
     * その後、勝利時の**既定の数列処理**（両端削除/分解/平均化）を**仕様順**で適用。
   * **LOSE** のとき：

     * 連勝数が**6以上**のときのみ、仕様式に従い**ストック**へ（連勝利益−通常利益）を加算し、連勝数を 0 にリセット。それ未満は連勝数を 0。
     * **左+右**を末尾に**追加**（数列拡張）。
     * 平均化ルールを仕様通りに適用（A/B 判定、左端0か否かで分岐）。 &#x20;
     * 続けて**ストック消費**（左端 ≤ ストック なら左端を 0 に）。
     * **0生成（再配布）**：左端>0 の場合は左端を 0 にし、**「合計数列値=（現行の合計）＋再配布値」**で再計算した**全体再配布**を規則通りに実行（未満/割り切れ/余りありの三分岐）。&#x20;

5. **状態の保存**

   * 更新済みの**初期数列・ストック・連勝数**を永続化（後述の永続化戦略）。

---

## 永続化戦略（信頼性・再起動耐性）

* **キーのスコープ**：`<Symbol> × <MagicNumber>` の組み合わせごとに独立管理。
* **保存方式**：

  * 推奨：`MQL4/Files` 配下に\*\*CSV（または1行カンマ区切り）\*\*で保存。
  * 代替：`GlobalVariablesOfTerminal` を使う場合は、配列を文字列化して 3 変数（SEQ/Stock/Winstreak）で保持。
* **保存タイミング**：

  * EA 起動/終了時、勝敗反映直後、ロット算出前に直前状態を読み込み。
* **復旧**：

  * ファイル/グローバル変数が欠落・破損している場合は初期化（{0,1}, 0, 0）。

---

## 勝敗判定（MQL4 実務ルール）

* **対象抽出**：`OrdersHistoryTotal()` を差分走査し、**未処理の Close 済チケット**を検出。Magic と Symbol でフィルタ。
* **判定**：\*\*損益合算（手数料・スワップ込）\*\*で WIN/LOSE を決定。
* **閾値**：微小誤差対策に `WinEpsMoney` を入力化（既定 0.0）。
* **部分決済**：各クローズイベントを独立判定・独立反映。
* **同時多発**：チケット番号昇順で**順番に** DMCMM へ反映（整合性を担保）。

---

## パラメータ（EA Inputs への追加/整理）

* `DMCMM_BaseLot`（double）… 基本ベット額に相当（最終ロット=（左+右）×BaseLot×連勝倍率）。&#x20;
* `DMCMM_WinEpsMoney`（double, default 0.0）… 勝ち判定の許容誤差。
* `DMCMM_PersistMode`（enum: FILE/GV）… 永続化方式。
* `DMCMM_LogLevel`（int 0–2）… ログ詳細度（0=最小,1=要点,2=詳細）。
* 既存の `MaxDrawdown` 等は**現状機能を維持**（ロット決定以外の制御は変更しない）。

---

## MoveCatcher2.mq4 への統合ポイント（手戻り防止のための手順）

1. **ロット算出フック**

   * 既存のロット決定箇所を特定し、**DMCMM の計算結果ロット**に置換。
   * ブローカー制約の正規化（最小/最大/ステップ）は置換後に適用。
   * ロットが 0 の場合は**発注スキップ**。

2. **勝敗反映フック**

   * 毎ティックで履歴差分を監視し、**未処理クローズ**を検出したら**即時 DMCMM へ反映**。
   * 反映の直後に状態を保存。

3. **起動/終了ハンドリング**

   * 起動時：状態ロード→なければ初期化。
   * 終了時：最新状態を保存。

4. **ログ**

   * 主要イベントにログを出す（例：`[DMCMM] seq=[…], stock=, streak=, bet=(L+R)=, lot=`）。
   * LogLevel に応じて平均化/0生成の分岐も記録（検証容易化のため）。

---

## 仕様の要点（順守チェックリスト）

* 初期化は {0,1}/0/0 から開始。
* ベット値=左端＋右端、ベット額=ベット値×基本ベット額。
* 連勝倍率は {0..2:×1, 3:×2, 4:×3, ≥5:×5}。
* WIN 時の**連勝数+1**は\*\*{0,1} 勝利時のみ\*\*。
* LOSE 時は（i）連勝ストック獲得条件の判定、（ii）**左+右**の追加、（iii）平均化、（iv）ストック消費、（v）0生成（再配布）を**仕様順**で行う。  &#x20;
* 0生成では**合計数列値=現行合計＋再配布値**として再配分を行う（ダブルカウント防止）。
* 各トレードの勝敗を**手数料・スワップ込みの純損益**で判定し、逐次反映。
* 状態は**シンボル×マジック**で分離・永続化。

---

## 受け入れ基準（テスト観点）

* 初期状態から 1 回目 LOSE → 数列が {0,1,1} へ拡張し、平均化・ストック/0生成が仕様どおり進むこと（ログで追跡）。
* WIN（{0,1} 状態）でのみ連勝数が +1 されること。
* 連勝数に応じた**倍率**がロットに反映されること（2→×1、3→×2、4→×3、5→×5 など）。
* EA 再起動後も連続性が保たれ、ロットの続きが正しく算出されること。
* ロット=0 のケースでは**発注されない**こと。

---

## 実装上の注意

* DMCMM の配列は**整数列**で管理（平均化・余剰配分は整数演算で規定）。&#x20;
* ロット正規化（MIN/MAX/STEP）は DMCMM の算出**後**に適用（丸めで誤差を入れない）。
* バックテスト時はヒストリーからの勝敗検出が**確実に一意**となるよう、**既処理チケット集合**を管理して二重反映を防止。
* 複数ポジ同時クローズでは**チケット番号昇順**で順次反映（順序非依存の安定挙動を担保）。

---

## 納品物

* `MoveCatcher2.mq4` の改修一式（ロット決定差し替え＋勝敗反映フック＋永続化）。
* 検証ログの取得方法（LogLevel=2 での出力項目一覧）。
* 既存機能（シグナル/発注/決済/保全）の**非変更保証の説明**。

以上に従い、Codex は `MoveCatcher2.mq4` のロット計算を DMCMM へ置換し、各トレードの勝敗判定・状態管理・永続化を実装すること。
